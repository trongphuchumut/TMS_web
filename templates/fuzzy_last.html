{% extends "base.html" %}
{% block title %}Fuzzy - Kết quả gần nhất{% endblock %}

{% block extra_css %}
<style>
  .fz-wrap{max-width:1180px;margin:0 auto;padding:16px 0 32px;}
  .fz-head{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:14px}
  .fz-title{font-size:22px;font-weight:900;color:var(--blue-strong);letter-spacing:.06em;text-transform:uppercase}
  .fz-sub{font-size:13px;color:#6b7280;max-width:820px;line-height:1.45}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 12px 28px rgba(2,6,23,.06);padding:14px 14px}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pill{border:1px solid #dbeafe;background:#eff6ff;border-radius:999px;padding:6px 10px;font-size:12px;color:#0f172a}
  .muted{color:#6b7280;font-size:13px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:10px 12px;border:1px solid #dbeafe;background:#fff;color:#0f172a;text-decoration:none;font-weight:800}
  .btn:hover{background:#eff6ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select{border:1px solid #e5e7eb;border-radius:12px;padding:9px 10px;background:#fff;font-weight:800}
  code{background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 6px;border-radius:8px}
  .warn{border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:14px;padding:10px 12px;font-weight:900}
  .hint{border:1px solid #dbeafe;background:#eff6ff;color:#0f172a;border-radius:14px;padding:10px 12px}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  .canvas-box{display:flex;justify-content:center;align-items:center;padding:10px;border:1px dashed #e5e7eb;border-radius:14px;background:linear-gradient(180deg,#ffffff,#f8fafc)}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .lg{display:flex;align-items:center;gap:8px;font-size:12px;color:#0f172a}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .hr{border:none;border-top:1px solid #eef2f7;margin:12px 0}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .small{font-size:12px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:740px){.two{grid-template-columns:1fr}}
</style>
{% endblock %}

{% block content %}
<div class="fz-wrap">
  <div class="fz-head">
    <div>
      <div class="fz-title">FUZZY RESULT</div>
      <div class="fz-sub">
        Trang này đọc trực tiếp JSON fuzzy gần nhất (không cần payload plot riêng).
        Biểu đồ tam giác vẽ từ <code>fuzzy.membership_defs</code>, chấm đỏ là <b>Query</b> và µ tính đúng theo tam giác.
        Bên dưới là Top đề xuất và biểu đồ điểm.
      </div>
    </div>

  </div>

  {% if not last %}
    <div class="card">
      <div style="font-weight:900;margin-bottom:6px;">Chưa có dữ liệu FUZZY</div>
      <div class="muted">Bạn hãy hỏi chatbot 1 câu có FUZZY rồi quay lại trang này.</div>
    </div>
  {% else %}
  <div class="grid">
    <!-- LEFT: Summary + Top list -->
    <div class="card">
      <div style="font-weight:900;margin-bottom:6px;">Câu hỏi gần nhất</div>
      <div style="white-space:pre-wrap">{{ last.question }}</div>

      <div class="kpi">
        <div class="pill">domain: <b>{{ last.domain|default:"-" }}</b></div>
        <div class="pill">confidence: <b>{{ last.meta.confidence|default:"-" }}</b></div>
        <div class="pill">filled: <b>{{ last.meta.filled_fields|default:""|length }}</b></div>
        <div class="pill">mode: <b>{{ last.meta.topk_mode|default:"-" }}</b></div>
        {% if last.meta.gap_top12 != None %}
          <div class="pill">gap(top1-top2): <b>{{ last.meta.gap_top12 }}</b></div>
        {% endif %}
      </div>

      <hr class="hr">

      <div class="two">
        <div class="hint">
          <div style="font-weight:900;margin-bottom:6px;">Cách đọc nhanh</div>
          <div class="muted">
            Nhìn tiêu chí (precision/durability/speed/cost) bạn đặt, xem µ rơi vào <b>low/med/high</b>.
            Nếu query nằm “High” ở tiêu chí quan trọng thì top đề xuất đáng tin hơn.
          </div>
        </div>

        <div class="hint">
          <div style="font-weight:900;margin-bottom:6px;">Debug nhanh</div>
          <div class="muted">
            Nếu biểu đồ báo thiếu <code>membership_defs</code> thì engine chưa gắn dữ liệu vẽ.
            Nếu có nhưng “kỳ”, kiểm tra thang input (0..10 hay 1..5) và set tam giác.
          </div>
        </div>
      </div>

      <hr class="hr">

      <div style="font-weight:900;margin-bottom:8px;">Top đề xuất</div>
      <ol id="topList" style="margin:0;padding-left:18px"></ol>

      <div id="notesBox" class="hint" style="margin-top:10px;display:none;"></div>
    </div>

    <!-- RIGHT: Charts -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <div style="font-weight:900;">Biểu đồ FUZZY</div>
        <div class="row">
          <span class="muted">Tiêu chí:</span>
          <select id="critSel"></select>
        </div>
      </div>

      <div id="plotWarn" class="warn" style="display:none;margin-bottom:10px;"></div>

      <div class="muted" id="critLabel" style="margin-bottom:10px;"></div>

      <div class="split">
        <div class="canvas-box">
          <canvas id="triChart" width="560" height="320"></canvas>
        </div>

        <div class="legend">
          <span class="lg"><span class="dot" style="background:#0ea5e9"></span> Set A</span>
          <span class="lg"><span class="dot" style="background:#6366f1"></span> Set B</span>
          <span class="lg"><span class="dot" style="background:#22c55e"></span> Set C</span>
          <span class="lg"><span class="dot" style="background:#ef4444"></span> Query</span>
        </div>

        <div class="muted small" id="muReadout"></div>

        <hr class="hr">

        <div style="font-weight:900;margin-bottom:6px;">Top 10 score</div>
        <div class="canvas-box">
          <canvas id="barChart" width="560" height="300"></canvas>
        </div>
        <div class="muted small">Trục X là điểm /100. Tên rút gọn để dễ nhìn.</div>
      </div>
    </div>
  </div>

  {# ===== payload: hỗ trợ cả dict lẫn string ===== #}
  {% if last_json %}
    {% if last_json|slice:":1" == "{" %}
      <script id="lastFuzzy" type="application/json">{{ last_json|safe }}</script>
    {% else %}
      {{ last_json|json_script:"lastFuzzy" }}
    {% endif %}
  {% else %}
    <script id="lastFuzzy" type="application/json">{}</script>
  {% endif %}

  {% endif %}

<script>
(function(){
  const dataEl = document.getElementById("lastFuzzy");
  const warnEl = document.getElementById("plotWarn");
  const sel = document.getElementById("critSel");
  const label = document.getElementById("critLabel");
  const triCanvas = document.getElementById("triChart");
  const barCanvas = document.getElementById("barChart");
  const topListEl = document.getElementById("topList");
  const muReadout = document.getElementById("muReadout");
  const notesBox = document.getElementById("notesBox");

  if (!dataEl || !warnEl || !sel || !label || !triCanvas || !barCanvas || !topListEl) return;

  function setWarn(msg){
    warnEl.style.display = "block";
    warnEl.innerHTML = msg;
  }

  let last = {};
  try { last = JSON.parse(dataEl.textContent || "{}"); }
  catch(e){
    setWarn("Payload JSON bị lỗi parse. Kiểm tra <code>last_json</code> truyền từ view.");
    label.textContent = "Không có dữ liệu plot để vẽ.";
    return;
  }

  // --- expected structure:
  // last.fuzzy.membership_defs, last.fuzzy.fuzzified, last.fuzzy.ranked
  const fuzzy = last.fuzzy || {};
  const membershipDefs = fuzzy.membership_defs || null;
  const fuzzified = fuzzy.fuzzified || null;

  // inputs may be in last.parse.inputs or fuzzy.user_inputs
  const parse = last.parse || {};
  const inputs = (parse.inputs && typeof parse.inputs === "object") ? parse.inputs :
                 (fuzzy.user_inputs && typeof fuzzy.user_inputs === "object") ? fuzzy.user_inputs : {};

  const ranked = Array.isArray(fuzzy.ranked) ? fuzzy.ranked : [];

  // --- render top list
  topListEl.innerHTML = "";
  if (ranked.length === 0){
    const li = document.createElement("li");
    li.innerHTML = "<b>Chưa có ranked</b> <span class='muted'>(fuzzy.ranked rỗng)</span>";
    topListEl.appendChild(li);
  } else {
    ranked.slice(0,10).forEach((r, i)=>{
      const li = document.createElement("li");
      const code = r.code ? ` <span class="muted">(${r.code})</span>` : "";
      li.innerHTML = `<b>${(r.name || r.code || ("Item "+(i+1)))}</b>${code}
                      <div class="muted">Điểm: <b>${r.score}</b>/100</div>`;
      topListEl.appendChild(li);
    });
  }

  // --- notes
  const breakdown = fuzzy.breakdown || {};
  const notes = Array.isArray(breakdown.notes) ? breakdown.notes : [];
  if (notes.length){
    notesBox.style.display = "block";
    notesBox.innerHTML = `<div style="font-weight:900;margin-bottom:6px;">Ghi chú engine</div>
                          <ul style="margin:0;padding-left:18px" class="muted">
                            ${notes.map(n=>`<li>${escapeHtml(String(n))}</li>`).join("")}
                          </ul>`;
  }

  // --- validate membership
  if (!membershipDefs || typeof membershipDefs !== "object" || Object.keys(membershipDefs).length === 0){
    setWarn("Thiếu <code>fuzzy.membership_defs</code>. Hãy gắn membership_defs trong engine (tool/holder) để vẽ tam giác.");
    label.textContent = "Không có membership_defs để vẽ.";
  }
  if (!fuzzified || typeof fuzzified !== "object"){
    setWarn("Thiếu <code>fuzzy.fuzzified</code>. UI vẫn vẽ tam giác, nhưng không có µ để hiển thị.");
  }

  // -----------------------------
  // Triangle chart
  // -----------------------------
  const tctx = triCanvas.getContext("2d");
  const W = triCanvas.width, H = triCanvas.height;
  const pad = 44;

  const axisColor = "#94a3b8";
  const gridColor = "#e5e7eb";
  const textColor = "#0f172a";
  const queryColor = "#ef4444";
  const setColors = ["#0ea5e9", "#6366f1", "#22c55e"]; // A/B/C

  function clear(ctx, w, h){ ctx.clearRect(0,0,w,h); }

  function xMap(v, umin, umax){
    const t = (v - umin) / (umax - umin || 1);
    return pad + (W - 2*pad) * t;
  }
  function yMap(mu){ return (H - pad) - (H - 2*pad) * mu; }

  function drawAxesTri(umin, umax){
    tctx.strokeStyle = axisColor;
    tctx.lineWidth = 1;
    tctx.beginPath();
    tctx.moveTo(pad, H-pad); tctx.lineTo(W-pad, H-pad);
    tctx.moveTo(pad, H-pad); tctx.lineTo(pad, pad);
    tctx.stroke();

    // x ticks
    tctx.fillStyle = textColor;
    tctx.font = "12px system-ui";
    const ticks = 5;
    for (let i=0;i<=ticks;i++){
      const v = umin + (umax-umin)*(i/ticks);
      const x = xMap(v, umin, umax);
      tctx.strokeStyle = gridColor;
      tctx.beginPath(); tctx.moveTo(x, H-pad); tctx.lineTo(x, H-pad+5); tctx.stroke();
      tctx.fillText(String(Math.round(v*10)/10), x-10, H-pad+18);
    }

    // y ticks
    [0,0.5,1].forEach(m=>{
      const y = yMap(m);
      tctx.strokeStyle = gridColor;
      tctx.beginPath(); tctx.moveTo(pad-5, y); tctx.lineTo(pad, y); tctx.stroke();
      tctx.fillStyle = textColor;
      tctx.fillText(m.toFixed(1), 12, y+4);
    });

    tctx.fillText("Value", W/2 - 18, H - 12);
    tctx.save();
    tctx.translate(14, H/2 + 24);
    tctx.rotate(-Math.PI/2);
    tctx.fillText("μ (membership)", 0, 0);
    tctx.restore();
  }

  function drawTriangle(name, abc, color, umin, umax){
    const a = abc[0], b = abc[1], c = abc[2];
    tctx.strokeStyle = color;
    tctx.lineWidth = 2;
    tctx.beginPath();
    tctx.moveTo(xMap(a, umin, umax), yMap(0));
    tctx.lineTo(xMap(b, umin, umax), yMap(1));
    tctx.lineTo(xMap(c, umin, umax), yMap(0));
    tctx.stroke();

    // label
    const mid = (a + c) / 2;
    tctx.fillStyle = color;
    tctx.font = "12px system-ui";
    tctx.fillText(String(name).toUpperCase(), xMap(mid, umin, umax)-14, yMap(0)+16);
  }

  function triMu(x, a, b, c){
    if (x <= a) return (a === b) ? 1 : 0;
    if (x >= c) return (b === c) ? 1 : 0;
    if (x === b) return 1;
    if (x < b) return (b !== a) ? (x - a) / (b - a) : 1;
    return (c !== b) ? (c - x) / (c - b) : 1;
  }

  function drawDot(x, mu, color, text, umin, umax){
    tctx.fillStyle = color;
    tctx.beginPath();
    tctx.arc(xMap(x, umin, umax), yMap(mu), 5.5, 0, Math.PI*2);
    tctx.fill();

    tctx.fillStyle = textColor;
    tctx.font = "12px system-ui";
    tctx.fillText(text, xMap(x, umin, umax)+8, yMap(mu)-8);
  }

  function bestSetMu(x, setsObj){
    let bestK = null, bestV = -1;
    Object.entries(setsObj || {}).forEach(([k, abc])=>{
      const mu = triMu(x, abc[0], abc[1], abc[2]);
      if (mu > bestV){ bestV = mu; bestK = k; }
    });
    return {set: bestK, mu: bestV};
  }

  function drawMembership(varKey){
    clear(tctx, W, H);

    const def = membershipDefs ? membershipDefs[varKey] : null;
    if (!def || !def.sets){
      drawAxesTri(0, 10);
      label.textContent = `Tiêu chí: ${varKey}`;
      muReadout.textContent = "Không có membership_defs cho tiêu chí này.";
      return;
    }

    const umin = (def.universe && def.universe.length>=2) ? Number(def.universe[0]) : 0;
    const umax = (def.universe && def.universe.length>=2) ? Number(def.universe[1]) : 10;

    drawAxesTri(umin, umax);

    const sets = def.sets || {};
    const keys = Object.keys(sets);

    // draw up to 3 sets (UI color A/B/C)
    keys.slice(0,3).forEach((k, i)=>{
      const abc = sets[k];
      if (Array.isArray(abc) && abc.length === 3){
        drawTriangle(k, abc, setColors[i] || "#64748b", umin, umax);
      }
    });

    // query value from inputs
    const qx = Number(inputs[varKey] ?? 0);
    const qbest = bestSetMu(qx, sets);
    drawDot(qx, qbest.mu, queryColor, `Query μ=${qbest.mu.toFixed(2)} (${qbest.set})`, umin, umax);

    label.textContent = `Tiêu chí: ${varKey}  • universe: ${umin}..${umax}  • used_in_scoring: ${def.used_in_scoring ? "yes" : "no"}`;

    // show µ readout (prefer fuzzified if available)
    let muText = "";
    const fv = fuzzified ? fuzzified[varKey] : null;
    if (fv && typeof fv === "object"){
      muText = Object.entries(fv).map(([k,v])=>`${k}=${Number(v).toFixed(2)}`).join("  |  ");
      muReadout.innerHTML = `<span class="mono">µ:</span> <span class="mono">${escapeHtml(muText)}</span>`;
    } else {
      // compute on the fly
      const calc = Object.entries(sets).map(([k,abc])=>{
        const mu = triMu(qx, abc[0], abc[1], abc[2]);
        return `${k}=${mu.toFixed(2)}`;
      }).join("  |  ");
      muReadout.innerHTML = `<span class="mono">µ (calc):</span> <span class="mono">${escapeHtml(calc)}</span>`;
    }
  }

  // -----------------------------
  // Bar chart Top10
  // -----------------------------
  const bctx = barCanvas.getContext("2d");
  const BW = barCanvas.width, BH = barCanvas.height;
  const bpadL = 160, bpadR = 18, bpadT = 18, bpadB = 24;

  function drawBars(){
    clear(bctx, BW, BH);

    // axes
    bctx.strokeStyle = axisColor;
    bctx.lineWidth = 1;
    bctx.beginPath();
    bctx.moveTo(bpadL, BH-bpadB); bctx.lineTo(BW-bpadR, BH-bpadB);
    bctx.moveTo(bpadL, BH-bpadB); bctx.lineTo(bpadL, bpadT);
    bctx.stroke();

    const items = ranked.slice(0, 10);
    if (!items.length){
      bctx.fillStyle = textColor;
      bctx.font = "13px system-ui";
      bctx.fillText("Không có dữ liệu ranked để vẽ.", bpadL+10, bpadT+20);
      return;
    }

    const maxScore = 100; // since score is /100
    const rowH = (BH - bpadT - bpadB) / items.length;

    // x grid ticks 0..100
    bctx.font = "12px system-ui";
    for (let t=0;t<=5;t++){
      const v = (maxScore * t/5);
      const x = bpadL + (BW - bpadL - bpadR) * (v / maxScore);
      bctx.strokeStyle = gridColor;
      bctx.beginPath(); bctx.moveTo(x, BH-bpadB); bctx.lineTo(x, bpadT); bctx.stroke();
      bctx.fillStyle = textColor;
      bctx.fillText(String(Math.round(v)), x-8, BH-6);
    }

    items.forEach((it, idx)=>{
      const y = bpadT + idx*rowH + rowH*0.18;
      const h = rowH*0.64;

      const name = shortName(it.name || it.code || ("Item "+(idx+1)), 22);
      const score = Number(it.score ?? 0);

      // label
      bctx.fillStyle = textColor;
      bctx.font = "12px system-ui";
      bctx.fillText(name, 12, y + h*0.72);

      // bar
      const w = (BW - bpadL - bpadR) * (score / maxScore);
      bctx.fillStyle = "#1d4ed8"; // stable blue for bar
      bctx.globalAlpha = 0.12;
      bctx.fillRect(bpadL, y, (BW-bpadL-bpadR), h);
      bctx.globalAlpha = 1;
      bctx.fillRect(bpadL, y, w, h);

      // score text
      bctx.fillStyle = textColor;
      bctx.fillText(score.toFixed(2), bpadL + w + 8, y + h*0.72);
    });

    bctx.fillStyle = textColor;
    bctx.font = "12px system-ui";
    bctx.fillText("Score / 100", BW/2 - 28, BH - 6);
  }

  // -----------------------------
  // UI wiring
  // -----------------------------
  sel.innerHTML = "";

  const critKeys = membershipDefs ? Object.keys(membershipDefs) : [];
  if (!critKeys.length){
    // fallback: try keys from inputs
    Object.keys(inputs || {}).forEach(k=>critKeys.push(k));
  }

  if (!critKeys.length){
    setWarn("Không có tiêu chí để vẽ. Cần <code>fuzzy.membership_defs</code> hoặc ít nhất <code>parse.inputs</code>.");
    label.textContent = "Không có tiêu chí.";
    drawBars();
    return;
  }

  critKeys.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", ()=>drawMembership(sel.value));

  // initial render
  drawMembership(critKeys[0]);
  drawBars();

  // -----------------------------
  // utils
  // -----------------------------
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function shortName(s, n){
    const t = String(s || "");
    return t.length > n ? (t.slice(0, n-1) + "…") : t;
  }
})();
</script>

</div>
{% endblock %}
