{% extends "base.html" %}
{% block title %}Fuzzy - K·∫øt qu·∫£ g·∫ßn nh·∫•t{% endblock %}

{% block extra_css %}
<style>
  .fz-wrap{max-width:1120px;margin:0 auto;padding:16px 0 32px;}
  .fz-head{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:14px}
  .fz-title{font-size:22px;font-weight:800;color:var(--blue-strong);letter-spacing:.04em;text-transform:uppercase}
  .fz-sub{font-size:13px;color:#6b7280}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 12px 28px rgba(2,6,23,.06);padding:14px 14px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pill{border:1px solid #dbeafe;background:#eff6ff;border-radius:999px;padding:6px 10px;font-size:12px;color:#0f172a}
  .toplist{margin:0;padding-left:18px}
  .toplist li{margin:6px 0}
  .muted{color:#6b7280;font-size:13px}
  .canvas-box{display:flex;justify-content:center;align-items:center;padding:10px;border:1px dashed #e5e7eb;border-radius:14px;background:linear-gradient(180deg,#ffffff,#f8fafc)}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:10px 12px;border:1px solid #dbeafe;background:#fff;color:#0f172a;text-decoration:none;font-weight:700}
  .btn:hover{background:#eff6ff}
  code{background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 6px;border-radius:8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select{border:1px solid #e5e7eb;border-radius:12px;padding:9px 10px;background:#fff;font-weight:700}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .lg{display:flex;align-items:center;gap:8px;font-size:12px;color:#0f172a}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .warn{border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:14px;padding:10px 12px;font-weight:800}
  .hint{border:1px solid #dbeafe;background:#eff6ff;color:#0f172a;border-radius:14px;padding:10px 12px}
</style>
{% endblock %}

{% block content %}
<div class="fz-wrap">
  <div class="fz-head">
    <div>
      <div class="fz-title">FUZZY RESULT</div>
      <div class="fz-sub">
        Trang n√†y hi·ªÉn th·ªã c√¢u h·ªèi fuzzy g·∫ßn nh·∫•t v√† bi·ªÉu ƒë·ªì membership theo t·ª´ng ti√™u ch√≠.
        Ch·∫•m ƒë·ªè l√† <b>query</b>; ch·∫•m ƒëen l√† <b>top ƒë√°p √°n</b> (Œº t√≠nh theo tam gi√°c).
      </div>
    </div>
    <div class="btnrow">
      <a class="btn" href="/chatbot/">‚¨ÖÔ∏è Quay l·∫°i Chatbot</a>
      <a class="btn" href="/chatbot/api/fuzzy/last/" target="_blank">üßæ JSON last</a>
    </div>
  </div>

  {% if not last %}
    <div class="card">
      <div style="font-weight:800;margin-bottom:6px;">Ch∆∞a c√≥ d·ªØ li·ªáu FUZZY</div>
      <div class="muted">B·∫°n h√£y h·ªèi chatbot 1 c√¢u c√≥ FUZZY r·ªìi quay l·∫°i trang n√†y.</div>
    </div>
  {% else %}
  <div class="grid">
    <div class="card">
      <div style="font-weight:800;margin-bottom:6px;">C√¢u h·ªèi g·∫ßn nh·∫•t</div>
      <div style="white-space:pre-wrap">{{ last.question }}</div>

      <div class="kpi">
        <div class="pill">confidence: {{ last.meta.confidence|default:"-" }}</div>
        <div class="pill">filled: {{ last.meta.filled_fields|default:""|length }}</div>
        <div class="pill">mode: {{ last.meta.topk_mode|default:"-" }}</div>
        {% if last.meta.gap_top12 != None %}
          <div class="pill">gap(top1-top2): {{ last.meta.gap_top12 }}</div>
        {% endif %}
      </div>

      <hr style="border:none;border-top:1px solid #eef2f7;margin:12px 0">

      <div style="font-weight:800;margin-bottom:8px;">Top ƒë·ªÅ xu·∫•t</div>
      <ol class="toplist">
        {% for r in last.top %}
          <li>
            <b>{{ r.name }}</b>{% if r.code %} <span class="muted">({{ r.code }})</span>{% endif %}
            <div class="muted">ƒêi·ªÉm: <b>{{ r.score }}</b>/100</div>
          </li>
        {% endfor %}
      </ol>

      <div class="hint" style="margin-top:10px;">
        <b>C√°ch ƒë·ªçc nhanh:</b> N·∫øu ch·∫•m <b>Query</b> v√† ch·∫•m <b>Top1</b> c√πng r∆°i v√†o v√πng <b>High</b> c·ªßa ti√™u ch√≠ quan tr·ªçng
        (v√≠ d·ª• ƒë∆∞·ªùng k√≠nh/v·∫≠t li·ªáu), th√¨ ƒë·ªÅ xu·∫•t ‚Äúh·ª£p l√Ω‚Äù.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <div style="font-weight:800;">Membership theo ti√™u ch√≠</div>
        <div class="row">
          <span class="muted">Ti√™u ch√≠:</span>
          <select id="critSel"></select>
        </div>
      </div>

      <div id="plotWarn" class="warn" style="display:none;margin-bottom:10px;"></div>

      <div class="muted" id="critLabel" style="margin-bottom:10px;"></div>

      <div class="canvas-box">
        <canvas id="triChart" width="520" height="320"></canvas>
      </div>

      <div class="legend">
        <span class="lg"><span class="dot" style="background:#0ea5e9"></span> Low</span>
        <span class="lg"><span class="dot" style="background:#6366f1"></span> Medium</span>
        <span class="lg"><span class="dot" style="background:#22c55e"></span> High</span>
        <span class="lg"><span class="dot" style="background:#ef4444"></span> Query</span>
        <span class="lg"><span class="dot" style="background:#111827"></span> Top</span>
      </div>

      <div class="muted" style="margin-top:10px;">
        L∆∞u √Ω: ch·∫•m ƒë∆∞·ª£c ƒë·∫∑t theo <b>(x = value)</b> v√† <b>(y = Œº(value))</b> n√™n ‚Äúƒë√∫ng fuzzy‚Äù, kh√¥ng ph·∫£i ch·∫•m cho ƒë·∫πp.
      </div>
    </div>
  </div>

  {# ===== payload: h·ªó tr·ª£ c·∫£ dict l·∫´n string ===== #}
  {% if last_json %}
    {% if last_json|slice:":1" == "{" %}
      <script id="lastFuzzy" type="application/json">{{ last_json|safe }}</script>
    {% else %}
      {{ last_json|json_script:"lastFuzzy" }}
    {% endif %}
  {% else %}
    <script id="lastFuzzy" type="application/json">{}</script>
  {% endif %}

  {% endif %}

<script>
(function(){
  const dataEl = document.getElementById("lastFuzzy");
  const warnEl = document.getElementById("plotWarn");
  const sel = document.getElementById("critSel");
  const label = document.getElementById("critLabel");
  const canvas = document.getElementById("triChart");
  if (!dataEl || !warnEl || !sel || !label || !canvas) return;

  function setWarn(msg){
    warnEl.style.display = "block";
    warnEl.innerHTML = msg;
  }

  let last = {};
  try{
    last = JSON.parse(dataEl.textContent || "{}");
  }catch(e){
    setWarn("Payload JSON b·ªã l·ªói parse. Ki·ªÉm tra <code>last_json</code> truy·ªÅn t·ª´ view.");
    label.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu plot ƒë·ªÉ v·∫Ω.";
    return;
  }

  const plot = last && last.meta && last.meta.plot && last.meta.plot.criteria;

  if (!plot || typeof plot !== "object" || Object.keys(plot).length === 0) {
    setWarn("Ch∆∞a c√≥ <code>last.meta.plot.criteria</code>. Pipeline c·∫ßn tr·∫£ v·ªÅ d·ªØ li·ªáu plot tr∆∞·ªõc.");
    label.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu plot ƒë·ªÉ v·∫Ω.";
    return;
  }

  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const pad = 44;

  const colors = { low:"#0ea5e9", medium:"#6366f1", high:"#22c55e" };
  const topColor = "#111827";
  const queryColor = "#ef4444";
  const axisColor = "#94a3b8";
  const textColor = "#0f172a";

  function xMap(v){ return pad + (W - 2*pad) * v; }
  function yMap(mu){ return (H - pad) - (H - 2*pad) * mu; }

  function triMu(x01, a, b, c){
    const x = x01 * 100;
    if (x <= a || x >= c) return 0;
    if (x === b) return 1;
    if (x < b) return (x - a) / (b - a);
    return (c - x) / (c - b);
  }

  function clear(){ ctx.clearRect(0,0,W,H); }

  function drawAxes(){
    ctx.strokeStyle = axisColor;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad);
    ctx.moveTo(pad, H-pad); ctx.lineTo(pad, pad);
    ctx.stroke();

    ctx.fillStyle = textColor;
    ctx.font = "12px system-ui";
    [0,0.25,0.5,0.75,1].forEach(t=>{
      const x = xMap(t);
      ctx.strokeStyle = "#e5e7eb";
      ctx.beginPath(); ctx.moveTo(x, H-pad); ctx.lineTo(x, H-pad+5); ctx.stroke();
      ctx.fillText(String(Math.round(t*100)), x-8, H-pad+18);
    });

    [0,0.5,1].forEach(m=>{
      const y = yMap(m);
      ctx.strokeStyle = "#e5e7eb";
      ctx.beginPath(); ctx.moveTo(pad-5, y); ctx.lineTo(pad, y); ctx.stroke();
      ctx.fillStyle = textColor;
      ctx.fillText(m.toFixed(1), 10, y+4);
    });

    ctx.fillText("Value (0..100)", W/2 - 44, H - 12);
    ctx.save();
    ctx.translate(14, H/2 + 24);
    ctx.rotate(-Math.PI/2);
    ctx.fillText("Œº (membership)", 0, 0);
    ctx.restore();
  }

  function drawTriangleSet(name, setDef){
    const {a,b,c} = setDef || {};
    if (a==null || b==null || c==null) return;

    ctx.strokeStyle = colors[name] || "#64748b";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xMap(a/100), yMap(0));
    ctx.lineTo(xMap(b/100), yMap(1));
    ctx.lineTo(xMap(c/100), yMap(0));
    ctx.stroke();

    ctx.fillStyle = ctx.strokeStyle;
    const mid = (a+c)/2;
    ctx.fillText(name.toUpperCase(), xMap(mid/100)-14, yMap(0)+16);
  }

  function drawDot(x01, mu, color, text){
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(xMap(x01), yMap(mu), 5.5, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = textColor;
    ctx.font = "12px system-ui";
    ctx.fillText(text, xMap(x01)+8, yMap(mu)-8);
  }

  function computeMuForAllSets(x01, sets){
    const mus = {};
    Object.entries(sets || {}).forEach(([k,s])=>{
      mus[k] = triMu(x01, s.a, s.b, s.c);
    });
    return mus;
  }

  function bestSet(mus){
    let bestK = null, bestV = -1;
    Object.entries(mus || {}).forEach(([k,v])=>{
      if (v > bestV){ bestV=v; bestK=k; }
    });
    return {set:bestK, mu:bestV};
  }

  function draw(criteriaKey){
    clear();
    drawAxes();

    const P = plot[criteriaKey];
    if (!P || !P.sets) return;

    label.textContent = `Ti√™u ch√≠: ${criteriaKey}`;

    ["low","medium","high"].forEach(k=>{
      if (P.sets[k]) drawTriangleSet(k, P.sets[k]);
    });

    const qx = Number(P.query ?? 0);
    const qMus = computeMuForAllSets(qx, P.sets);
    const qBest = bestSet(qMus);
    drawDot(qx, qBest.mu, queryColor, `Query Œº=${qBest.mu.toFixed(2)} (${qBest.set})`);

    const tops = Array.isArray(P.tops) ? P.tops.slice(0,5) : [];
    tops.forEach((t, idx)=>{
      const vx = Number(t.value ?? 0);
      const mus = computeMuForAllSets(vx, P.sets);
      const b = bestSet(mus);
      drawDot(vx, b.mu, topColor, `Top${idx+1} Œº=${b.mu.toFixed(2)} (${b.set})`);
    });
  }

  sel.innerHTML = "";
  const keys = Object.keys(plot);
  keys.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", ()=>draw(sel.value));
  draw(keys[0]);
})();
</script>

</div>
{% endblock %}
