{% extends "base.html" %}
{% block title %}Đang xử lý giao dịch holder{% endblock %}

{% block content %}
<div style="max-width:600px;margin:40px auto;text-align:center;">
  <h2 style="font-size:22px;font-weight:700;margin-bottom:8px;">
    Đang xử lý giao dịch holder...
  </h2>
  <p style="color:#6b7280;margin-bottom:16px;">
    Vui lòng thao tác với tủ theo hướng dẫn. Hệ thống sẽ tự cập nhật kết quả.
  </p>

  <div id="status-box" style="
      padding:16px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:14px;
  ">
    <p id="status-text">Đang chờ phản hồi từ tủ (tx_id: {{ tx_id }})...</p>
  </div>
</div>

<script>
  const mode = "{{ mode|default:'borrow' }}";  // 'borrow' | 'return'
  const checkUrl = (mode === "return")
    ? "{% url 'holder_muontra:api_check_return_tx' tx_id=tx_id %}"
    : "{% url 'holder_muontra:api_check_borrow_tx' tx_id=tx_id %}";

  const redirectUrl = "{% url 'holder_muontra:history_holder' %}";
  const startMs = Date.now();
  const MAX_WAIT_SEC = 60;

  const box = document.getElementById("status-box");
  const text = document.getElementById("status-text");

  async function checkStatus() {
    try {
      const res = await fetch(checkUrl, { cache: "no-store" });
      const data = await res.json();
      if (!data || !data.status) return;

      const elapsed = (Date.now() - startMs) / 1000;

      if (data.status === "PENDING") {
        text.textContent = `Đang chờ tủ xử lý... (${Math.floor(elapsed)}s)`;
        if (elapsed > MAX_WAIT_SEC) {
          alert("⏱ Hệ thống chờ quá lâu. Vui lòng kiểm tra tủ hoặc thử lại.");
          window.location.href = redirectUrl;
        }
        return;
      }

      if (data.status === "SUCCESS" || data.status === "DANG_MUON" || data.status === "DA_TRA") {
        alert("✔ Giao dịch thành công!");
        window.location.href = redirectUrl;
        return;
      }

      if (data.status === "FAILED") {
        alert("❌ Giao dịch thất bại: " + (data.reason || "timeout"));
        window.location.href = redirectUrl;
        return;
      }

      // Trạng thái khác (hiếm)
      text.textContent = "Trạng thái: " + data.status;

    } catch (err) {
      console.error("Error checking holder tx:", err);
    }
  }

  // tick ngay 1 phát cho đỡ phải chờ 2s
  checkStatus();
  setInterval(checkStatus, 2000);
</script>
{% endblock %}
